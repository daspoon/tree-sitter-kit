# Create and sign an xcframework bundle containing a version of libtree_sitter_cli.a  
# for each macos supported architecture.

# TODO: ${PWD}/.build/checkouts/tree-sitter
TREE_SITTER=/Users/dave/Developer/Projects/tree-sitter

# TODO: param defaulting to release
CONFIGURATION=debug

MANIFEST_PATH=${TREE_SITTER}/cli/Cargo.toml
LIB_NAME=libtree_sitter_cli.a
INCLUDE=${TREE_SITTER}/cli/include
TARGET_DIR=${PWD}/.build/cargo
UNIVERSAL_LIB=${TARGET_DIR}/${LIB_NAME}
FRAMEWORK=${PWD}/XCFrameworks/TreeSitterCLI.xcframework

set -x

# Build for each platform
cargo build --manifest-path ${MANIFEST_PATH} --lib --target-dir ${TARGET_DIR} --target aarch64-apple-darwin
cargo build --manifest-path ${MANIFEST_PATH} --lib --target-dir ${TARGET_DIR} --target  x86_64-apple-darwin

# Combine as a universal binary
lipo ${TARGET_DIR}/aarch64-apple-darwin/${CONFIGURATION}/${LIB_NAME} ${TARGET_DIR}/x86_64-apple-darwin/${CONFIGURATION}/${LIB_NAME} -create -output ${UNIVERSAL_LIB}

# Bundle as an Xcode framework
if [ -d ${FRAMEWORK} ]; then rm -rf ${FRAMEWORK}; fi
xcodebuild -create-xcframework -library ${UNIVERSAL_LIB} -headers ${INCLUDE} -output ${FRAMEWORK}

# Sign the bundle
codesign --timestamp -s "Apple Development:" ${FRAMEWORK}
